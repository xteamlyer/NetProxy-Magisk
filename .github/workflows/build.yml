name: æ„å»ºæ¨¡å—ä¸é€šçŸ¥

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v5

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webui/package-lock.json

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£… WebUI ä¾èµ–
        working-directory: webui
        run: npm install

      - name: æ„å»º WebUI
        working-directory: webui
        run: python build_webui.py

      - name: æ‰“åŒ… NetProxy æ¨¡å—
        run: |
          cd NetProxy-Module
          zip -r ../NetProxy-Module.zip .

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: NetProxy-Module
          path: NetProxy-Module.zip

  notify:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: æ„å»ºæˆåŠŸé€šçŸ¥
        if: ${{ needs.build.result == 'success' && github.event_name == 'push' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸ¤– *NetProxyBot é€šçŸ¥*
            âœ… æ„å»ºæˆåŠŸï¼
            
            ğŸ“¦ ä»“åº“: `${{ github.repository }}`
            ğŸŒ¿ åˆ†æ”¯: `${{ github.ref_name }}`
            ğŸ§¾ Commit: `${{ github.sha }}`
            
            ğŸ”— [æŸ¥çœ‹ Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: æ„å»ºå¤±è´¥é€šçŸ¥
        if: ${{ needs.build.result != 'success' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸ¤– *NetProxyBot é€šçŸ¥*
            âŒ æ„å»ºå¤±è´¥ï¼
            
            ğŸ“¦ ä»“åº“: `${{ github.repository }}`
            ğŸŒ¿ åˆ†æ”¯: `${{ github.ref_name }}`
            ğŸ§¾ Commit: `${{ github.sha }}`
            
            ğŸ”— [æŸ¥çœ‹ Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Release å‘å¸ƒé€šçŸ¥
        if: ${{ github.event_name == 'release' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸ‰ *NetProxyBot é€šçŸ¥*
            ğŸ·ï¸ æ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            ğŸ”– ç‰ˆæœ¬: `${{ github.event.release.tag_name }}`
            ğŸ“ è¯´æ˜: `${{ github.event.release.name }}`
            
            â¬‡ï¸ ä¸‹è½½: [Release é¡µé¢](https://github.com/${{ github.repository }}/releases/latest)
