## 版本 4.0.1（2025-12-30）

## ⚠️ 重要提示（4.0.1）

本版本 **已移除 `status.conf`**，并在 `module.conf` 中 **新增 `CURRENT_CONFIG` 字段**，用于记录当前生效的配置文件。

由于当前安装脚本 **不会覆盖安装 `config` 目录下的文件**，如果你是从旧版本升级：

* 现有配置文件 **不会被覆盖**
* 但 `module.conf` 中 **可能缺少 `CURRENT_CONFIG` 字段**
* 从而导致部分功能异常（如状态显示、配置切换异常）

**解决方式：**

* **推荐方式**：卸载旧版本后重新安装 4.0.1，以确保配置文件完整
* **手动方式**：从发布的压缩包中，将最新的 `module.conf` 复制到模块目录下的 `config` 目录中

---

### 核心状态管理与服务控制

* 重构 Xray 运行状态检测机制

  * 使用 `pidof -s /data/adb/modules/netproxy/bin/xray` 判断真实运行状态
  * 状态由「文件记录」改为「进程真实状态」，避免状态不同步问题
* 配置状态管理重构

  * 移除 `status.conf`
  * 在 `module.conf` 中新增 `CURRENT_CONFIG` 字段，用于记录当前生效配置
* 启停与配置切换逻辑调整

  * `start.sh`：启动时从 `module.conf` 读取并同步当前配置
  * `switch-config.sh`：切换配置时更新 `CURRENT_CONFIG`
  * `stop.sh`：移除所有 `status.conf` 相关逻辑，统一使用 `pidof` 获取进程 ID
  * WebUI / KSU Service：服务状态统一基于进程检测判断

---

### 协议与代理修复

* 修复 WebSocket（ws）配置缺少 `tlsSettings` 的问题
* OnePlus A16 兼容性修复

  * 修复修复开关启用后未立即生效的问题

---

### 脚本与系统兼容性优化

* 适配 APatch 的 busybox 路径
* 简化 `start.sh`

  * 移除无意义的配置写入操作
* `stop.sh` 改为使用 `pidof` 获取进程 ID

---

### WebUI 与主题系统

* 主题系统增强

  * 新增莫奈取色功能开关
  * 自动模式下支持系统动态取色
  * 优化主题颜色标记与应用逻辑
* 应用代理页面重构

  * 支持多用户显示
  * 支持显示系统应用
  * 支持关闭分应用代理设置
* 新增统一的外部链接打开方法
* 同步优化相关 UI 组件样式

---

### 依赖升级

* KernelSU：`^2.1.1` → `^3.0.0`
* MDUI：`^2.0.0` → `^2.1.4`
* Parcel：`^2.14.0` → `^2.16.3`